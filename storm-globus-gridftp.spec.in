# Copyright (c) Istituto Nazionale di Fisica Nucleare (INFN). 2006-2010.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

%define name         @PACKAGE@
%define version      @VERSION@
%define release      @STORM_GLOBUS_GRIDFTP_AGE_NUMBER@.@STORM_GLOBUS_GRIDFTP_SO@

%define libtype      @LIBTYPE@
%define globusdir    @GLOBUS_LOCATION@

%define libattrdir    @LIBATTR_LOCATION@
%define libattrdevdir @LIBATTR_DEVEL_LOCATION@

%define zlibdir      @ZLIB_LOCATION@
%define zlibdevdir   @ZLIB_DEVEL_LOCATION@

%define stormgridftpdir @STORM_GRIDFTP_LOCATION@

%define prefixname   @PACKAGE_PREFIX_NAME@
%define shortname    @PACKAGE_SHORT_NAME@
%define longname     @PACKAGE_LONG_NAME@

Summary:        GridFTP2 DSI for StoRM
Name:           %{name}
Version:        %{version}
Release:        %{release}
Vendor:         EMI
Packager:       Elisabetta Ronchieri <elisabetta.ronchieri@cnaf.infn.it>
License:        Apache License, Version 2.0
URL:            http://storm.forge.cnaf.infn.it
Source:         @PACKAGE@-%{version}.tar.gz
Group:          Applications/Libraries
AutoReqProv:    yes
BuildRoot:      %{_builddir}/var/tmp/%{name}-%{version}
Summary:        The StoRM GridFtp DSI component

BuildRequires: libtool
BuildRequires: storm-common
BuildRequires: zlib
BuildRequires: openssl-devel
BuildRequires: libattr-devel
BuildRequires: globus-gridftp-server-devel
BuildRequires: globus-ftp-control-devel
BuildRequires: globus-ftp-client-devel

Requires(post):   chkconfig
Requires(preun):  chkconfig
Requires(preun):  initscripts
Requires(postun): initscripts

Requires: globus-gssapi-gsi
Requires: openssl
Requires: zlib
Requires: globus-gridftp-server-progs

%define debug_package %{nil}

%description
GridFTP2 DSI calculates checksum on the fly for StoRM

%prep
%setup -n @PACKAGE@-%{version}

%build
./bootstrap emi.storm.common
./configure --prefix=/usr --sysconfdir=/etc --datadir=/usr/share --localstatedir=/var --with-storm-gridftp-location=%{stormgridftpdir} --with-libattr-prefix=%{libattrdir} --with-libattr-devel-prefix=%{libattrdevdir} --with-zlib-prefix=%{zlibdir} --with-zlib-devel-prefix=%{zlibdevdir} 
make

%install
if [ -d $RPM_BUILD_ROOT ]; then rm -rf $RPM_BUILD_ROOT; fi
mkdir -p $RPM_BUILD_ROOT
make install DESTDIR=$RPM_BUILD_ROOT
rm -f $RPM_BUILD_ROOT/usr/%{libtype}/libglobus_gridftp_server_StoRM.la
rm -f $RPM_BUILD_ROOT/usr/%{libtype}/libglobus_gridftp_server_StoRM.a
mkdir -p $RPM_BUILD_ROOT/%{_localstatedir}/log/%{prefixname}

%post
#during an install, the value of the argument passed in is 1
#during an unupgrade, the value of the argument passed in is 2
if [ "$1" = "1" ] ; then
  echo 'add service to chkconfig'
  /sbin/chkconfig --add storm-globus-gridftp
fi;
if [ "$1" = "2" ] ; then
  echo "The StoRM GridFtp DSI server has been upgraded but NOT configured yet.
You need to use yaim to configure the server.
"
  echo 'stop service'
  /sbin/service storm-globus-gridftp stop >/dev/null 2>&1 || :
fi;

%preun
#during an upgrade, the value of the argument passed in is 1
#during an uninstall, the value of the argument passed in is 0
if [ "$1" = "0" ] ; then
  echo 'stop service'
  /sbin/service storm-globus-gridftp stop >/dev/null 2>&1 || :
  echo 'del service from chkconfig'
  /sbin/chkconfig --del storm-globus-gridftp
fi;
if [ "$1" = "1" ] ; then
  echo "The StoRM GridFtp DSI server has been upgraded but NOT configured yet.
You need to use yaim to configure the server.
"
  echo 'stop service'
  /sbin/service storm-globus-gridftp stop >/dev/null 2>&1 || :
fi;

%postun
#during an upgrade, the value of the argument passed in is 1
#during an uninstall, the value of the argument passed in is 0
if [ "$1" = "1" ] ; then
  echo "The StoRM GridFtp DSI server has been upgraded but NOT configured yet.
You need to use yaim to configure the server.
"
  echo 'stop service'
  /sbin/service storm-globus-gridftp stop >/dev/null 2>&1 || :
fi;
if [ "$1" = "0" ] ; then
  echo 'remove old file'
  rm -f /etc/init.d/storm-globus-gridftp.*
fi

%clean
rm -rf $RPM_BUILD_ROOT

%files 
%defattr(-,root,root)
%{_sysconfdir}/init.d/storm-globus-gridftp
%config(noreplace) %attr(644,root,root) %{_sysconfdir}/logrotate.d/storm-globus-gridftp

/usr/%{libtype}/libglobus_gridftp_server_StoRM.so
/usr/%{libtype}/libglobus_gridftp_server_StoRM.so.0
/usr/%{libtype}/libglobus_gridftp_server_StoRM.so.0.0.0

%doc %dir %{_datadir}/doc/%{name}-%{version}
%doc %{_datadir}/doc/%{name}-%{version}/ChangeLog
%doc %{_datadir}/doc/%{name}-%{version}/CREDITS
%doc %{_datadir}/doc/%{name}-%{version}/LICENSE
%doc %{_datadir}/doc/%{name}-%{version}/README

%dir %{_localstatedir}/log/%{prefixname}

%changelog
* Mon May 02 2011 Elisabetta Roncheiri <elisabetta.ronchieri@cnaf.infn.it> - 1.1.0-5.sl5
- Added BuildRequires in spec file
- Added src in the src tar file
- Cleaned configuration file

* Thu Apr 07 2011 Elisabetta Ronchieri> <elisabetta.ronchieri@cnaf.infn.it> - 1.1.0-4.sl5
- Renamed globus-gridftp in storm-globus-gridftp
- Changed log path and log file names

* Fri Feb 24 2011 Elisabetta Ronchieri> <elisabetta.ronchieri@cnaf.infn.it> - 1.1.0-2.sl5
- Added Fedora guidelines
